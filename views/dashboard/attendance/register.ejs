<!doctype html>
<html class="no-js" lang="ar">
<%- include('../../partials/head.ejs') %>

<body class="rtl">
<div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">

  <%- include('../../partials/header.ejs') %>
  <div id="dw-s1" class="bmd-layout-drawer bg-faded">
    <%- include('../../partials/sidebar/index.ejs') %>
  </div>

<main class="bmd-layout-content">
<div class="container-fluid mt-3">
  <input type="hidden" id="csrfToken" value="<%= csrfToken %>">

  <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>

  <!-- Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ -->
  <div id="attendanceAlert" class="alert alert-warning" style="display:none;"></div>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ -->
  <div class="form-group">
    <label>Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</label>
    <select id="classSelect" class="form-control">
      <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ --</option>
      <% classes.forEach(c => { %>
        <option value="<%= c._id %>"><%= c.name %></option>
      <% }) %>
    </select>
  </div>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© -->
  <div class="form-group">
    <label>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
    <select id="sectionSelect" class="form-control" disabled>
      <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© --</option>
    </select>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
  <div id="studentsContainer" style="display:none;">
    <div class="table-responsive">
    <table class="table table-bordered text-center">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨/Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="studentsTable"></tbody>
    </table>
    </div>
    </div>
    <button id="saveAttendanceBtn" class="btn btn-success">Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
  </div>

</div>
</main>

<%- include('../../partials/scripts.ejs') %>

<script>
const classSelect = document.getElementById('classSelect');
const sectionSelect = document.getElementById('sectionSelect');
const studentsContainer = document.getElementById('studentsContainer');
const studentsTable = document.getElementById('studentsTable');
const alertBox = document.getElementById('attendanceAlert');
const csrfToken = document.getElementById('csrfToken').value;

let currentClassId = '';
let currentSectionId = '';
let studentsData = [];

// Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø¹Ø¨
classSelect.addEventListener('change', async () => {
  currentClassId = classSelect.value;
  sectionSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© --</option>';
  sectionSelect.disabled = true;
  studentsContainer.style.display = 'none';
  alertBox.style.display = 'none';

  if (!currentClassId) return;

  const res = await fetch(`/attendance/sections/${currentClassId}`);
  const sections = await res.json();

  sections.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s._id;
    opt.textContent = s.name;
    sectionSelect.appendChild(opt);
  });

  sectionSelect.disabled = false;
});

// Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨
sectionSelect.addEventListener('change', async () => {
  currentSectionId = sectionSelect.value;
  studentsContainer.style.display = 'none';
  alertBox.style.display = 'none';

  if (!currentSectionId) return;

  const res = await fetch(`/attendance/students/${currentSectionId}`);
  const data = await res.json();

  // ğŸ”´ Ø¥Ø°Ø§ Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ø³Ø¬Ù‘Ù„
  if (data.alreadyRecorded) {
    alertBox.textContent = data.message;
    alertBox.style.display = 'block';
    sectionSelect.value = '';
    return;
  }

  studentsData = data.students;
  studentsTable.innerHTML = '';

  studentsData.forEach(student => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${student.fullName}</td>
      <td>
        <select class="form-control statusSelect">
          <option value="present">Ø­Ø§Ø¶Ø±</option>
          <option value="absent">ØºØ§Ø¦Ø¨</option>
          <option value="late">Ù…ØªØ£Ø®Ø±</option>
          <option value="excused">Ù…Ø£Ø°ÙˆÙ†</option>
        </select>
      </td>
      <td><input type="text" class="form-control reasonInput" disabled></td>
      <td><input type="text" class="form-control notesInput"></td>
    `;
    studentsTable.appendChild(tr);

    const statusSelect = tr.querySelector('.statusSelect');
    const reasonInput = tr.querySelector('.reasonInput');

    statusSelect.addEventListener('change', () => {
      reasonInput.disabled = statusSelect.value === 'present';
      if (reasonInput.disabled) reasonInput.value = '';
    });
  });

  studentsContainer.style.display = 'block';
});

// Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±
document.getElementById('saveAttendanceBtn').addEventListener('click', async () => {
  if (!currentClassId || !currentSectionId) return;

  const attendances = studentsData.map((student, i) => ({
    studentId: student._id,
    classId: currentClassId,
    sectionId: currentSectionId,
    status: studentsTable.rows[i].querySelector('.statusSelect').value,
    reason: studentsTable.rows[i].querySelector('.reasonInput').value,
    notes: studentsTable.rows[i].querySelector('.notesInput').value
  }));

  const res = await fetch('/attendance/save', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'CSRF-Token': csrfToken
    },
    body: JSON.stringify({ attendances, date: new Date() })
  });

  const data = await res.json();

  if (data.error) {
    alertBox.textContent = data.error;
    alertBox.style.display = 'block';
    return;
  }

  alert(data.success);
  studentsContainer.style.display = 'none';
  sectionSelect.value = '';
});
</script>

</body>
</html>
