<!doctype html>
<html class="no-js" lang="ar">

<%- include('../../partials/head.ejs') %>

<body class="rtl">

<div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">

<%- include('../../partials/header.ejs') %>

<div id="dw-s1" class="bmd-layout-drawer bg-faded">
  <%- include('../../partials/sidebar/index.ejs') %>
</div>

<main class="bmd-layout-content">
<div class="container-fluid">

  <!-- Page Header -->
  <div class="row m-1 pb-3 mb-3">
    <div class="col-12 p-2">
      <div class="page-header breadcrumb-header d-flex justify-content-between align-items-center">
        <div>
          <h3 class="lite-text mb-1"><i class="fas fa-user-graduate"></i> بيانات الطالب</h3>
          <span class="lite-text text-gray">عرض جميع بيانات الطالب وسجل العلامات</span>
        </div>
        <div>
          <a href="/school-admin/students" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> العودة لطلابي
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Student Info Card -->
  <div class="row m-1 justify-content-center">
    <div class="col-lg-10 col-md-12 p-2">
      <div class="card shade">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-info-circle"></i> معلومات الطالب
        </div>
        <div class="card-body">
          <table class="table table-bordered">
            <tbody>
              <tr><th>الاسم الكامل</th><td><%= student.fullName %></td></tr>
              <tr><th>رقم هوية الطالب</th><td><%= student.nationalId %></td></tr>
              <tr><th>تاريخ الميلاد</th><td><%= student.dateOfBirth ? student.dateOfBirth.toLocaleDateString() : '—' %></td></tr>
              <tr><th>الفصل</th><td><%= student.classId ? student.classId.name : '—' %></td></tr>
              <tr><th>الشعبة</th><td><%= student.sectionId ? student.sectionId.name : '—' %></td></tr>
              <tr><th>الجنس</th><td><%= student.gender == 'Male' ? 'ذكر' : student.gender == 'Female' ? 'أنثى' : '—' %></td></tr>
              <tr><th>رقم ولي الأمر</th><td><%= student.phoneOfParents || '—' %></td></tr>
              <tr><th>العنوان</th><td><%= student.address || '—' %></td></tr>
              <tr><th>تاريخ الإضافة</th><td><%= student.createdAt.toLocaleDateString() %></td></tr>
            </tbody>
          </table>
          <div class="mt-3">
            <a href="" class="btn btn-warning">شهادات الطالب</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Grades History Card -->
  <div class="row m-1 justify-content-center">
    <div class="col-lg-10 col-md-12 p-2">
      <div class="card shade">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <span><i class="fas fa-clipboard-list"></i> سجل العلامات</span>
          <div class="btn-group no-print">
            <button id="exportExcel" class="btn btn-light btn-sm">
              <i class="fas fa-file-excel"></i> Excel
            </button>
            <button id="printBtn" class="btn btn-light btn-sm">
              <i class="fas fa-print"></i> طباعة
            </button>
          </div>
        </div>
        <div class="card-body">
          <% if (grades && grades.length > 0) { %>
          <table class="table table-striped table-bordered" id="gradesTable">
            <thead class="thead-dark">
              <tr>
                <th>المادة</th>
                <th>نوع الاختبار</th>
                <th>الدرجة</th>
                <th>المعلم</th>
                <th>تاريخ الإدخال</th>
                <th>ملاحظات</th>
              </tr>
            </thead>
            <tbody>
              <% grades.forEach(grade => { %>
                <tr>
                  <td><%= grade.subjectId.name %></td>
                  <td><%= grade.examId ? grade.examId.type === 'quiz' ? 'اختبار سريع' :
                                    grade.examId.type === 'monthly' ? 'شهري' :
                                    grade.examId.type === 'midterm' ? 'نصفي' :
                                    grade.examId.type === 'final' ? 'نهائي' : '-' : '-' %></td>
                  <td><%= grade.score %> / <%= grade.examId ? grade.examId.maxScore : '-' %></td>
                  <td><%= grade.teacherId.name %></td>
                  <td><%= grade.createdAt.toLocaleDateString() %></td>
                  <td><%= grade.notes || '—' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
          <% } else { %>
            <p class="text-muted text-center">لا توجد علامات مسجلة لهذا الطالب بعد.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

</div>
</main>

<%- include('../../partials/scripts.ejs') %>

<!-- SheetJS and Export Script -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  // Export Excel
  document.getElementById('exportExcel').addEventListener('click', () => {
    const table = document.getElementById('gradesTable');
    const ws = XLSX.utils.table_to_sheet(table);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Grades");
    XLSX.writeFile(wb, `${'<%= student.fullName.replace(/\\s/g, "_") %>'}_Grades.xlsx`);
  });

  // Print Table
  document.getElementById('printBtn').addEventListener('click', () => {
    const studentInfo = `
      <h3>بيانات الطالب: <%= student.fullName %></h3>
      <p>الصف: <%= student.classId.name %> | الشعبة: <%= student.sectionId.name %> | رقم ولي الأمر: <%= student.phoneOfParents || '-' %></p>
    `;
    const tableHtml = document.getElementById('gradesTable').outerHTML;
    const win = window.open('', '', 'width=1000,height=700');
    win.document.write(`
      <html>
        <head>
          <title>سجل علامات <%= student.fullName %></title>
          <style>
            body { direction: rtl; font-family: Arial; padding: 10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #000; padding: 6px; text-align: center; }
            h3 { margin-bottom: 0; }
            p { margin: 2px 0 10px 0; }
          </style>
        </head>
        <body>
          ${studentInfo}
          ${tableHtml}
        </body>
      </html>
    `);
    win.document.close();
    win.print();
  });
</script>

<style>
  @media print {
    .no-print, header, #dw-s1, .breadcrumb-header, .btn-warning { display: none !important; }
    body { direction: rtl; }
    table { width: 100%; border-collapse: collapse; }
  }
</style>

</body>
</html>
