<!doctype html>
<html class="no-js" lang="ar">

<%- include('../../partials/head.ejs') %>
<body class="rtl">
<div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">
  <%- include('../../partials/header.ejs') %>
  <div id="dw-s1" class="bmd-layout-drawer bg-faded">
    <%- include('../../partials/sidebar/index.ejs') %>
  </div>

  <main class="bmd-layout-content">
    <div class="container-fluid">
      <h3>إضافة وارد جديد</h3>

      <% if (locals.success && locals.success.length > 0) { %>
        <div class="alert alert-success"><%= locals.success %></div>
      <% } %>
      <% if (locals.error && locals.error.length > 0) { %>
        <div class="alert alert-danger"><%= locals.error %></div>
      <% } %>

      <form id="addIncomeForm" class="text-right">
        <div class="form-group">
          <label>المورد *</label>
          <select name="supplierId" id="supplierSelect" class="form-control" required>
            <option value="">اختر المورد</option>
            <% suppliers.forEach(s => { %>
              <option value="<%= s._id %>"><%= s.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="form-group">
          <label>المبلغ *</label>
          <input type="number" name="amount" class="form-control" required>
        </div>
        <div class="form-group">
          <label>الوصف</label>
          <textarea name="description" class="form-control"></textarea>
        </div>
        <button type="submit" class="btn btn-success">إضافة الوارد</button>
      </form>
    </div>
  </main>
</div>

<%- include('../../partials/scripts.ejs') %>

<script>
document.getElementById('addIncomeForm').addEventListener('submit', async e => {
  e.preventDefault();

  const formData = {
    supplierId: document.getElementById('supplierSelect').value,
    amount: document.querySelector('input[name="amount"]').value,
    description: document.querySelector('textarea[name="description"]').value
  };

  const res = await fetch('/school-admin/incomes/create', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(formData)
  });

  const data = await res.json();
  if(data.errors){
    alert(data.errors.general || "Error");
  } else if(data.success){
    alert(data.success);
    if(data.redirect) window.location.href = data.redirect;
  }
});
</script>
</body>
</html>
