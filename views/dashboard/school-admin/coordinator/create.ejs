<!doctype html>
<html class="no-js" lang="ar">
<%- include('../../../partials/head.ejs') %>

<body class="rtl">
<div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">

  <%- include('../../../partials/header.ejs') %>

  <div id="dw-s1" class="bmd-layout-drawer bg-faded">
    <%- include('../../../partials/sidebar/index.ejs') %>
  </div>

  <main class="bmd-layout-content">
    <div class="container-fluid">

      <!-- Page Header -->
      <div class="row m-1 pb-3 mb-3">
        <div class="col-12 p-2">
          <div class="page-header breadcrumb-header d-flex justify-content-between align-items-center">
            <div>
              <h3 class="lite-text mb-1">
                <i class="fas fa-user-cog"></i> إضافة منسق المدرسة
              </h3>
              <span class="lite-text text-gray">إدخال بيانات منسق المدرسة</span>
            </div>
            <div>
              <a href="/school-admin/coordinator" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> رجوع
              </a>
            </div>
          </div>
        </div>
      </div>

   

      <!-- Form -->
      <div class="row m-1">
        <div class="col-12 p-2">
          <div class="card shade">
            <div class="card-header bg-primary text-white">
              <i class="fas fa-user-plus"></i> بيانات المنسق
            </div>

            <div class="card-body">

              <form id="createCoordinatorForm" class="text-right">
                <input type="hidden" id="csrfToken" value="<%= csrfToken %>">

                <div class="row">

                  <div class="col-md-6 form-group">
                    <label>الاسم الكامل *</label>
                    <input type="text" id="name" class="form-control" value="<%= old.name || '' %>">
                    <small class="text-danger" id="nameError"></small>
                  </div>

                  <div class="col-md-6 form-group">
                    <label>البريد الإلكتروني *</label>
                    <input type="email" id="email" class="form-control" value="<%= old.email || '' %>">
                    <small class="text-danger" id="emailError"></small>
                  </div>

                  <div class="col-md-6 form-group">
                    <label>كلمة المرور *</label>
                    <input type="password" id="password" class="form-control">
                    <small class="text-danger" id="passwordError"></small>
                  </div>

                  <div class="col-md-6 form-group">
                    <label>رقم الهاتف *</label>
                    <input type="text" id="phone" class="form-control" value="<%= old.phone || '' %>">
                    <small class="text-danger" id="phoneError"></small>
                  </div>

                </div>

                <hr>

                <button type="submit" class="btn btn-success">
                  <i class="fas fa-save"></i> حفظ
                </button>

              </form>

            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<%- include('../../../partials/scripts.ejs') %>

<script>
const form = document.getElementById('createCoordinatorForm');
const csrfToken = document.getElementById('csrfToken').value;
const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/;

form.addEventListener('submit', async e => {
  e.preventDefault();

  // تنظيف الأخطاء
  ['name','email','password','phone'].forEach(f => document.getElementById(f+'Error').textContent='');

  const data = {
    name: document.getElementById('name').value.trim(),
    email: document.getElementById('email').value.trim(),
    password: document.getElementById('password').value.trim(),
    phone: document.getElementById('phone').value.trim()
  };

  let hasError = false;

  if(!data.name){ document.getElementById('nameError').textContent="اسم المنسق مطلوب"; hasError=true; }
  if(!data.email){ document.getElementById('emailError').textContent="البريد الإلكتروني مطلوب"; hasError=true; }
  if(!data.password){ document.getElementById('passwordError').textContent="كلمة المرور مطلوبة"; hasError=true; }
  else if(!strongPasswordRegex.test(data.password)){
    document.getElementById('passwordError').textContent="كلمة المرور يجب أن تحتوي على 8 أحرف على الأقل، حرف كبير، حرف صغير، رقم ورمز خاص";
    hasError=true;
  }
  if(!data.phone){ document.getElementById('phoneError').textContent="رقم الهاتف مطلوب"; hasError=true; }

  if(hasError) return;

  try {
    const res = await fetch('/school-admin/coordinator/create', {
      method:'POST',
      headers:{'Content-Type':'application/json','CSRF-Token':csrfToken},
      body:JSON.stringify(data)
    });

    const result = await res.json();

    if(result.errors){
      Object.keys(result.errors).forEach(k=>{
        const el=document.getElementById(k+'Error');
        if(el) el.textContent=result.errors[k].msg;
      });
    } else if(result.success){
      window.location.href='/school-admin/coordinator';
    } else if(result.flashError){
      alert(result.flashError);
    }
  } catch(err){
    console.error(err);
    alert('حدث خطأ أثناء إرسال البيانات');
  }
});
</script>

</body>
</html>
