<!doctype html>
<html class="no-js" lang="ar">

<%- include('../../../partials/head.ejs') %>

<body class="rtl">

  <div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">

    <%- include('../../../partials/header.ejs') %>

    <div id="dw-s1" class="bmd-layout-drawer bg-faded">
      <%- include('../../../partials/sidebar/index.ejs') %>
    </div>

    <main class="bmd-layout-content">
      <div class="container-fluid">

        <!-- breadcrumb -->
        <div class="row m-1 pb-4 mb-3">
          <div class="col-12 p-2">
            <div class="page-header breadcrumb-header">
              <div class="row align-items-end">
                <div class="col-lg-8">
                  <h3 class="lite-text">ุงุณุชูุฑุงุฏ ุงูุทูุงุจ ูู ููู Excel</h3>
                  <span class="lite-text text-gray">ุงุฎุชุฑ ุงููุตู ูุงูุดุนุจุฉ ุซู ุงุณุชูุฑุฏ ููู Excel</span>
                </div>
                <div class="col-lg-4">
                  <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/dashboard"><i class="fas fa-home"></i></a></li>
                    <li class="breadcrumb-item active">ุงุณุชูุฑุงุฏ ุงูุทูุงุจ</li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Excel Import Form -->
        <div class="row m-1">
          <div class="col-12 p-2">
            <div class="card shade h-100">
              <div class="card-header">
                ุงุณุชูุฑุงุฏ ุงูุทูุงุจ
              </div>
              <div class="card-body">

                <% if (locals.success && locals.success.length > 0) { %>
                  <div class="alert alert-success"><%= locals.success %></div>
                <% } %>

                <% if (locals.error && locals.error.length > 0) { %>
                  <div class="alert alert-danger"><%= locals.error %></div>
                <% } %>

                <form id="importExcelForm" enctype="multipart/form-data" method="POST">
                 <input type="hidden" name="_csrf" id="csrfToken" value="<%= csrfToken %>">


                  <div class="form-group">
                    <label>ุงููุตู *</label>
                    <select name="classId" id="classSelect" class="form-control" required>
                      <option value="">ุงุฎุชุฑ ุงููุตู</option>
                      <% classes.forEach(cls => { %>
                        <option value="<%= cls._id %>"><%= cls.name %></option>
                      <% }) %>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>ุงูุดุนุจุฉ *</label>
                    <select name="sectionId" id="sectionSelect" class="form-control" required>
                      <option value="">ุงุฎุชุฑ ุงูุดุนุจุฉ</option>
                      <% sections.forEach(sec => { %>
                        <option value="<%= sec._id %>" data-class="<%= sec.classId %>"><%= sec.name %></option>
                      <% }) %>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>ููู Excel *</label>
                    <input type="file" name="excelFile" accept=".xlsx,.xls" required class="form-control">
                  </div>

                  <button type="submit" class="btn btn-primary">ุงุณุชูุฑุงุฏ ุงูุทูุงุจ</button>
                </form>

              </div>
            </div>
          </div>
        </div>

      </div>
    </main>

  </div>

  <%- include('../../../partials/scripts.ejs') %>

<script>
  const classSelect = document.getElementById('classSelect');
  const sectionSelect = document.getElementById('sectionSelect');
  const importExcelForm = document.getElementById('importExcelForm');
  const csrfToken = document.getElementById('csrfToken').value;

  // ููุชุฑุฉ ุงูุดุนุจ ุญุณุจ ุงููุตู ุงููุฎุชุงุฑ
  classSelect.addEventListener('change', () => {
    const selectedClass = classSelect.value;
    Array.from(sectionSelect.options).forEach(opt => {
      if(opt.value === "") return;
      if(opt.dataset.class === selectedClass){
        opt.style.display = '';
      } else {
        opt.style.display = 'none';
      }
    });
    sectionSelect.value = "";
  });

  // ุฅุฑุณุงู ุงูููุฑู ุนุจุฑ AJAX ูุน CSRF
  importExcelForm.addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(importExcelForm);

    try {
      const res = await fetch('/school-admin/students/import-excel', {
        method: 'POST',
        body: formData,
        headers:{'CSRF-Token': csrfToken},
        credentials: 'same-origin' // ๐ ุฅุฑุณุงู ุงูููููุฒ
      });

      const data = await res.json();

      if(data.error) {
        alert(data.error);
      } else {
        alert(`${data.success}\nุชู ุงุณุชูุฑุงุฏ ${data.imported} ูู ุฃุตู ${data.totalRows} ุตู`);
      }

    } catch(err) {
      console.error(err);
      alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชูุฑุงุฏ ุงูููู");
    }
  });
</script>

</body>
</html>
