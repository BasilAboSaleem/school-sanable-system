<!doctype html>
<html class="no-js" lang="ar">

<%- include('../../../partials/head.ejs') %>

<body class="rtl">

  <div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">

    <%- include('../../../partials/header.ejs') %>

    <div id="dw-s1" class="bmd-layout-drawer bg-faded">
      <%- include('../../../partials/sidebar/index.ejs') %>
    </div>

    <main class="bmd-layout-content">
      <div class="container-fluid">

        <!-- breadcrumb -->
        <div class="row m-1 pb-4 mb-3">
          <div class="col-12 p-2">
            <div class="page-header breadcrumb-header">
              <div class="row align-items-end">
                <div class="col-lg-8">
                  <h3 class="lite-text">إضافة مورد جديد</h3>
                  <span class="lite-text text-gray">أدخل بيانات المورد الجديد</span>
                </div>
                <div class="col-lg-4">
                  <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/dashboard"><i class="fas fa-home"></i></a></li>
                    <li class="breadcrumb-item active">إضافة مورد جديد</li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- form -->
        <div class="row m-1">
          <div class="col-12 p-2">
            <div class="card shade h-100">
              <div class="card-header">
                إضافة مورد جديد
              </div>
              <div class="card-body">

                     <!-- Flash Messages -->
         <% if (locals.success && locals.success.length > 0) { %>
  <div class="alert alert-success"><%= locals.success %></div>
<% } %>

<% if (locals.error && locals.error.length > 0) { %>
  <div class="alert alert-danger"><%= locals.error %></div>
<% } %>

                <form id="addSupplierForm" action="/school-admin/suppliers/create" method="POST" class="text-right">
  <div class="form-group">
    <label>اسم المورد *</label>
    <input type="text" name="name" id="supplierNameInput" required class="form-control">
    <small class="text-danger" id="nameError"></small>
  </div>

  <div class="form-group">
    <label>البريد الإلكتروني</label>
    <input type="email" name="email" class="form-control">
  </div>

  <div class="form-group">
    <label>رقم الهاتف</label>
    <input type="text" name="phone" class="form-control">
  </div>

  <div class="form-group">
    <label>العنوان</label>
    <input type="text" name="address" class="form-control">
  </div>

  <div class="form-group">
    <label>ملاحظات</label>
    <textarea name="notes" class="form-control"></textarea>
  </div>

  <button type="submit" class="btn btn-success">إضافة المورد</button>
</form>


              </div>
            </div>
          </div>
        </div>

      </div>
    </main>

  </div>

  <%- include('../../../partials/scripts.ejs') %>

<script>
  const supplierForm = document.getElementById('addSupplierForm');
  const nameInput = document.getElementById('supplierNameInput');
  const nameError = document.getElementById('nameError');

  supplierForm.addEventListener('submit', async e => {
    e.preventDefault();
    nameError.textContent = '';

    if (!nameInput.value.trim()) {
      nameError.textContent = "اسم المورد مطلوب";
      return;
    }

    const formData = {
      name: nameInput.value,
      email: document.querySelector('input[name="email"]').value,
      phone: document.querySelector('input[name="phone"]').value,
      address: document.querySelector('input[name="address"]').value,
      notes: document.querySelector('textarea[name="notes"]').value
    };

    try {
      const res = await fetch('/school-admin/suppliers/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
      });

      const data = await res.json();

      if (data.errors) {
        if (data.errors.name) nameError.textContent = data.errors.name;
        if (data.errors.general) alert(data.errors.general);
      } else if (data.success) {
        alert(data.success);
        if (data.redirect) window.location.href = data.redirect;
      }
    } catch (err) {
      alert("حدث خطأ أثناء الإرسال");
      console.error(err);
    }
  });
</script>

</body>
</html>
