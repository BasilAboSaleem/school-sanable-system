<!doctype html>
<html class="no-js" lang="ar">

<%- include('../../../partials/head.ejs') %>

<body class="rtl">

  <div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">

    <%- include('../../../partials/header.ejs') %>

    <div id="dw-s1" class="bmd-layout-drawer bg-faded">
      <%- include('../../../partials/sidebar/index.ejs') %>
    </div>

    <main class="bmd-layout-content">
      <div class="container-fluid">

        <!-- breadcrumb -->
        <div class="row m-1 pb-4 mb-3">
          <div class="col-12 p-2">
            <div class="page-header breadcrumb-header">
              <div class="row align-items-end">
                <div class="col-lg-8">
                  <div class="page-header-title text-left-rtl">
                    <div class="d-inline">
                      <h3 class="lite-text">إضافة مدرس جديد</h3>
                      <span class="lite-text text-gray">أدخل بيانات المدرس الجديد</span>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4">
                  <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/dashboard"><i class="fas fa-home"></i></a></li>
                    <li class="breadcrumb-item active">إضافة مدرس</li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- الفورم لإضافة مدرس -->
        <div class="row m-1">
          <div class="col-12 p-2">
            <div class="card shade h-100">
              <div class="card-header">
                إضافة مدرس جديد
              </div>
              <div class="card-body">

                <% if(flash && flash.error){ %>
                  <div class="alert alert-danger"><%= flash.error %></div>
                <% } %>
                <% if(flash && flash.success){ %>
                  <div class="alert alert-success"><%= flash.success %></div>
                <% } %>

                <form id="addTeacherForm" action="/school-admin/teachers/create" method="POST" class="text-right">
                  <div class="form-group">
                    <label>الاسم الكامل *</label>
                    <input type="text" name="name" id="teacherNameInput" required class="form-control">
                    <small class="text-danger" id="nameError"></small>
                  </div>

                  <div class="form-group">
                    <label>البريد الإلكتروني *</label>
                    <input type="email" name="email" id="teacherEmailInput" required class="form-control">
                    <small class="text-danger" id="emailError"></small>
                  </div>

                  <div class="form-group">
                    <label>كلمة المرور *</label>
                    <input type="password" name="password" id="teacherPasswordInput" required class="form-control">
                    <small class="text-danger" id="passwordError"></small>
                  </div>

                  <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="text" name="phone" class="form-control">
                  </div>

                <select name="classes[]" id="classesSelect" class="form-control" multiple>
  <% classes.forEach(cls => { %>
    <option value="<%= cls._id %>" data-sections='<%= JSON.stringify(cls.sections.map(s => ({ id: s._id, name: s.name }))) %>'>
      <%= cls.name %>
    </option>
  <% }) %>
</select>


                  <div class="form-group">
 <div class="form-group">
  <label>الشعب</label>
  <select name="sections[]" id="sectionsSelect" class="form-control" multiple>
    <!-- سيتم ملؤه بالـ JS -->
  </select>
</div>


                  <div class="form-group">
                    <label>المواد</label>
                    <select name="subjects[]" class="form-control" multiple>
                      <% subjects.forEach(sub => { %>
                        <option value="<%= sub._id %>"><%= sub.name %></option>
                      <% }) %>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>الحالة</label>
                    <select name="status" class="form-control">
                      <option value="active">نشط</option>
                      <option value="inactive">غير نشط</option>
                    </select>
                  </div>

                  <button type="submit" class="btn btn-success">إضافة المدرس</button>
                </form>

              </div>
            </div>
          </div>
        </div>

      </div>
    </main>

  </div>

  <%- include('../../../partials/scripts.ejs') %>

<script>
  const teacherNameInput = document.getElementById('teacherNameInput');
  const nameError = document.getElementById('nameError');
  const teacherEmailInput = document.getElementById('teacherEmailInput');
  const emailError = document.getElementById('emailError');
  const teacherPasswordInput = document.getElementById('teacherPasswordInput');
  const passwordError = document.getElementById('passwordError');
  const classesSelect = document.querySelector('select[name="classes[]"]');
  const sectionsSelect = document.querySelector('select[name="sections[]"]');

  const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/;

  // جميع الشعب لكل فصل مخزنة في HTML عن طريق data
  const classSections = {};
  <% classes.forEach(cls => { %>
    classSections["<%= cls._id %>"] = [
      <% cls.sections.forEach(sec => { %>
        { id: "<%= sec._id %>", name: "<%= cls.name %> - <%= sec.name %>" },
      <% }) %>
    ];
  <% }) %>

  // تحديث قائمة الشعب عند اختيار الفصول
  function updateSections() {
    const selectedClasses = Array.from(classesSelect.selectedOptions).map(o => o.value);
    sectionsSelect.innerHTML = '';
    selectedClasses.forEach(classId => {
      if(classSections[classId]) {
        classSections[classId].forEach(sec => {
          const option = document.createElement('option');
          option.value = sec.id;
          option.textContent = sec.name;
          sectionsSelect.appendChild(option);
        });
      }
    });
  }

  classesSelect.addEventListener('change', updateSections);

  // التحقق من البريد عند الخروج
  teacherEmailInput.addEventListener('blur', async () => {
    const email = teacherEmailInput.value.trim();
    if(!email) return;
    const res = await fetch('/school-admin/teachers/create', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, checkField: 'email' })
    });
    const data = await res.json();
    emailError.textContent = data.error || '';
  });

  // التحقق من كلمة المرور عند الخروج
  teacherPasswordInput.addEventListener('blur', () => {
    const password = teacherPasswordInput.value.trim();
    if(!password) {
      passwordError.textContent = "كلمة المرور مطلوبة";
    } else if(!strongPasswordRegex.test(password)) {
      passwordError.textContent = "كلمة المرور يجب أن تحتوي على 8 أحرف على الأقل، حرف كبير، حرف صغير، رقم ورمز خاص";
    } else {
      passwordError.textContent = "";
    }
  });

  // إرسال الفورم
  document.getElementById('addTeacherForm').addEventListener('submit', async e => {
    e.preventDefault();

    // تنظيف الأخطاء
    nameError.textContent = '';
    emailError.textContent = '';
    passwordError.textContent = '';

    const name = teacherNameInput.value.trim();
    const email = teacherEmailInput.value.trim();
    const password = teacherPasswordInput.value.trim();

    let hasError = false;

    if(!name){ nameError.textContent = "الاسم مطلوب"; hasError = true; }
    if(!email){ emailError.textContent = "البريد الإلكتروني مطلوب"; hasError = true; }

    // تحقق كلمة المرور
    if(!password){ passwordError.textContent = "كلمة المرور مطلوبة"; hasError = true; }
    else if(!strongPasswordRegex.test(password)){
      passwordError.textContent = "كلمة المرور يجب أن تحتوي على 8 أحرف على الأقل، حرف كبير، حرف صغير، رقم ورمز خاص";
      hasError = true;
    }

    if(hasError) return;

    // تحقق البريد الإلكتروني قبل الإرسال
    const emailCheckRes = await fetch('/school-admin/teachers/create', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, checkField: 'email' })
    });
    const emailData = await emailCheckRes.json();
    if(emailData.error){
      emailError.textContent = emailData.error;
      return;
    }

    // إرسال البيانات للسيرفر
    const formData = {
      name,
      email,
      password,
      phone: document.querySelector('input[name="phone"]').value,
      classes: Array.from(classesSelect.selectedOptions).map(o => o.value),
      sections: Array.from(sectionsSelect.selectedOptions).map(o => o.value),
      subjects: Array.from(document.querySelector('select[name="subjects[]"]').selectedOptions).map(o => o.value),
      status: document.querySelector('select[name="status"]').value
    };

    const res = await fetch('/school-admin/teachers/create', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(formData)
    });

    const data = await res.json();
    if(data.errors){
      if(data.errors.name) nameError.textContent = data.errors.name;
      if(data.errors.email) emailError.textContent = data.errors.email;
      if(data.errors.password) passwordError.textContent = data.errors.password;
      if(data.errors.general) alert(data.errors.general);
    } else if(data.success){
      alert(data.success);
      window.location.href="/school-admin/teachers";
    }
  });

  // تهيئة الشعب عند تحميل الصفحة (اختياري)
  updateSections();
</script>





</body>
</html>
