<!doctype html>
<html class="no-js" lang="ar">

<%- include('../../../partials/head.ejs') %>

<body class="rtl">

  <div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">

    <%- include('../../../partials/header.ejs') %>

    <div id="dw-s1" class="bmd-layout-drawer bg-faded">
      <%- include('../../../partials/sidebar/index.ejs') %>
    </div>

    <main class="bmd-layout-content">
      <div class="container-fluid">

        <!-- breadcrumb -->
        <div class="row m-1 pb-4 mb-3">
          <div class="col-12 p-2">
            <div class="page-header breadcrumb-header">
              <div class="row align-items-end">
                <div class="col-lg-8">
                  <h3 class="lite-text">تعديل بيانات المدرس</h3>
                  <span class="lite-text text-gray">قم بتحديث بيانات المدرس المختار</span>
                </div>
                <div class="col-lg-4">
                  <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/dashboard"><i class="fas fa-home"></i></a></li>
                    <li class="breadcrumb-item active">تعديل مدرس</li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- الفورم لتعديل المدرس -->
        <div class="row m-1">
          <div class="col-12 p-2">
            <div class="card shade h-100">
              <div class="card-header">
                تعديل بيانات المدرس
              </div>
              <div class="card-body">

              <% if (locals.error && locals.error.length > 0) { %>
  <div class="alert alert-danger"><%= error %></div>
<% } %>

<% if (locals.success && locals.success.length > 0) { %>
  <div class="alert alert-success"><%= success %></div>
<% } %>


                <form id="editTeacherForm" action="/school-admin/teachers/<%= teacher._id %>/edit" method="POST" class="text-right">
                  <div class="form-group">
                    <label>الاسم الكامل *</label>
                    <input type="text" name="name" id="teacherNameInput" required class="form-control" value="<%= teacher.name %>">
                    <small class="text-danger" id="nameError"></small>
                  </div>

                  <div class="form-group">
                    <label>البريد الإلكتروني *</label>
                    <input type="email" name="email" id="teacherEmailInput" required class="form-control" value="<%= teacher.email %>">
                    <small class="text-danger" id="emailError"></small>
                  </div>

                  <div class="form-group">
                    <label>كلمة المرور (اتركها فارغة إذا لم تتغير)</label>
                    <input type="password" name="password" id="teacherPasswordInput" class="form-control">
                    <small class="text-danger" id="passwordError"></small>
                  </div>

                  <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="text" name="phone" class="form-control" value="<%= teacher.phone %>">
                  </div>

                  <div class="form-group">
                    <label>الفصول</label>
                    <select name="classes[]" class="form-control" multiple>
                      <% classes.forEach(cls => { %>
                        <option value="<%= cls._id %>" <%= teacher.classes.includes(cls._id) ? "selected" : "" %>><%= cls.name %></option>
                      <% }) %>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>المواد</label>
                    <select name="subjects[]" class="form-control" multiple>
                      <% subjects.forEach(sub => { %>
                        <option value="<%= sub._id %>" <%= teacher.subjects.includes(sub._id) ? "selected" : "" %>><%= sub.name %></option>
                      <% }) %>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>الحالة</label>
                    <select name="status" class="form-control">
                      <option value="active" <%= teacher.status === 'active' ? 'selected' : '' %>>نشط</option>
                      <option value="inactive" <%= teacher.status === 'inactive' ? 'selected' : '' %>>غير نشط</option>
                    </select>
                  </div>

                  <button type="submit" class="btn btn-success">تحديث البيانات</button>
                </form>

              </div>
            </div>
          </div>
        </div>

      </div>
    </main>

  </div>

  <%- include('../../../partials/scripts.ejs') %>

  <script>
    const teacherNameInput = document.getElementById('teacherNameInput');
    const nameError = document.getElementById('nameError');
    const teacherEmailInput = document.getElementById('teacherEmailInput');
    const emailError = document.getElementById('emailError');

    // AJAX للتحقق من البريد الإلكتروني الفريد عند الخروج من الحقل
    teacherEmailInput.addEventListener('blur', async () => {
      const email = teacherEmailInput.value.trim();
      if(!email) return;

      const res = await fetch('/school-admin/teachers/<%= teacher._id %>/edit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email, checkField: 'email' })
      });
      const data = await res.json();
      emailError.textContent = data.error || '';
    });

    // إرسال الفورم
    document.getElementById('editTeacherForm').addEventListener('submit', async e => {
      e.preventDefault();

      nameError.textContent = '';
      emailError.textContent = '';

      if(!teacherNameInput.value.trim()){
        nameError.textContent = "الاسم مطلوب";
        return;
      }

      if(!teacherEmailInput.value.trim()){
        emailError.textContent = "البريد الإلكتروني مطلوب";
        return;
      }

      const formData = {
        name: teacherNameInput.value,
        email: teacherEmailInput.value,
        password: document.getElementById('teacherPasswordInput').value,
        phone: document.querySelector('input[name="phone"]').value,
        classes: Array.from(document.querySelector('select[name="classes[]"]').selectedOptions).map(o => o.value),
        subjects: Array.from(document.querySelector('select[name="subjects[]"]').selectedOptions).map(o => o.value),
        status: document.querySelector('select[name="status"]').value
      };

      const res = await fetch('/school-admin/teachers/<%= teacher._id %>/edit', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(formData)
      });
      const data = await res.json();

      if(data.errors){
        if(data.errors.name) nameError.textContent = data.errors.name;
        if(data.errors.email) emailError.textContent = data.errors.email;
        if(data.errors.general) alert(data.errors.general);
      } else if(data.success){
        alert(data.success);
        window.location.href="/school-admin/teachers";
      }
    });
  </script>

</body>
</html>
