<!doctype html>
<html class="no-js" lang="ar">

<%- include('../../../partials/head.ejs') %>

<body class="rtl">

  <div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">
    <%- include('../../../partials/header.ejs') %>
    <div id="dw-s1" class="bmd-layout-drawer bg-faded">
      <%- include('../../../partials/sidebar/index.ejs') %>
    </div>

    <main class="bmd-layout-content">
      <div class="container-fluid">

        <div class="row m-1 pb-4 mb-3">
          <div class="col-12 p-2">
            <div class="page-header breadcrumb-header">
              <div class="row align-items-end">
                <div class="col-lg-8">
                  <h3 class="lite-text">تعديل بيانات المدرس</h3>
                  <span class="lite-text text-gray">قم بتحديث بيانات المدرس المختار</span>
                </div>
                <div class="col-lg-4">
                  <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/dashboard"><i class="fas fa-home"></i></a></li>
                    <li class="breadcrumb-item active">تعديل مدرس</li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- الفورم لتعديل المدرس -->
        <div class="row m-1">
          <div class="col-12 p-2">
            <div class="card shade h-100">
              <div class="card-header">تعديل بيانات المدرس</div>
              <div class="card-body">

                <% if (locals.error && locals.error.length > 0) { %>
                  <div class="alert alert-danger"><%= error %></div>
                <% } %>
                <% if (locals.success && locals.success.length > 0) { %>
                  <div class="alert alert-success"><%= success %></div>
                <% } %>

                <form id="editTeacherForm" class="text-right">
                  <div class="form-group">
                    <label>الاسم الكامل *</label>
                    <input type="text" name="name" id="teacherNameInput" required class="form-control" value="<%= teacher.name %>">
                    <small class="text-danger" id="nameError"></small>
                  </div>

                  <div class="form-group">
                    <label>البريد الإلكتروني *</label>
                    <input type="email" name="email" id="teacherEmailInput" required class="form-control" value="<%= teacher.email %>">
                    <small class="text-danger" id="emailError"></small>
                  </div>

                  <div class="form-group">
                    <label>كلمة المرور (اتركها فارغة إذا لم تتغير)</label>
                    <input type="password" name="password" id="teacherPasswordInput" class="form-control">
                    <small class="text-danger" id="passwordError"></small>
                  </div>

                  <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="text" name="phone" class="form-control" value="<%= teacher.phone %>">
                  </div>

                  <div class="form-group">
                    <label>الفصول</label>
                    <select name="classes[]" class="form-control" multiple id="classesSelect">
                      <% classes.forEach(cls => { %>
                        <option value="<%= cls._id %>" <%= teacher.classes.map(c=>c._id.toString()).includes(cls._id.toString()) ? "selected" : "" %>><%= cls.name %></option>
                      <% }) %>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>الشعب</label>
                    <select name="sections[]" class="form-control" multiple id="sectionsSelect"></select>
                  </div>

                  <div class="form-group">
                    <label>المواد</label>
                    <select name="subjects[]" class="form-control" multiple id="subjectsSelect">
                      <% subjects.forEach(sub => { %>
                        <option value="<%= sub._id %>" <%= teacher.subjects.map(s=>s._id.toString()).includes(sub._id.toString()) ? "selected" : "" %>><%= sub.name %></option>
                      <% }) %>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>الحالة</label>
                    <select name="status" class="form-control" id="statusSelect">
                      <option value="active" <%= teacher.status==='active'?'selected':'' %>>نشط</option>
                      <option value="inactive" <%= teacher.status==='inactive'?'selected':'' %>>غير نشط</option>
                    </select>
                  </div>

                  <button type="submit" class="btn btn-success">تحديث البيانات</button>
                </form>

              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <%- include('../../../partials/scripts.ejs') %>

  <script>
    const teacherNameInput = document.getElementById('teacherNameInput');
    const nameError = document.getElementById('nameError');
    const teacherEmailInput = document.getElementById('teacherEmailInput');
    const emailError = document.getElementById('emailError');
    const teacherPasswordInput = document.getElementById('teacherPasswordInput');
    const passwordError = document.getElementById('passwordError');
    const classesSelect = document.getElementById('classesSelect');
    const sectionsSelect = document.getElementById('sectionsSelect');
    const subjectsSelect = document.getElementById('subjectsSelect');
    const statusSelect = document.getElementById('statusSelect');

    const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/;

    // الشعب لكل فصل
    const classSections = {};
    <% classes.forEach(cls => { %>
      classSections["<%= cls._id %>"] = [
        <% cls.sections.forEach(sec => { %>
          { id: "<%= sec._id %>", name: "<%= cls.name %> - <%= sec.name %>" },
        <% }) %>
      ];
    <% }) %>

    // قيم المعلم الحالية
    const teacherClasses = <%- JSON.stringify(teacher.classes.map(c=>c._id.toString())) %>;
    const teacherSections = <%- JSON.stringify(teacher.sections.map(s=>s._id.toString())) %>;
    const teacherSubjects = <%- JSON.stringify(teacher.subjects.map(s=>s._id.toString())) %>;

    function updateSections() {
      const selectedClasses = Array.from(classesSelect.selectedOptions).map(o=>o.value);
      const selectedSections = [];

      sectionsSelect.innerHTML = '';
      selectedClasses.forEach(classId=>{
        if(classSections[classId]){
          classSections[classId].forEach(sec=>{
            const option = document.createElement('option');
            option.value = sec.id;
            option.textContent = sec.name;
            if(teacherSections.includes(sec.id)) option.selected = true;
            sectionsSelect.appendChild(option);
          });
        }
      });
    }

    function initSelections(){
      Array.from(classesSelect.options).forEach(o=>{
        if(teacherClasses.includes(o.value)) o.selected=true;
      });
      Array.from(subjectsSelect.options).forEach(o=>{
        if(teacherSubjects.includes(o.value)) o.selected=true;
      });
      updateSections();
    }

    classesSelect.addEventListener('change', updateSections);

    // تحقق البريد
    teacherEmailInput.addEventListener('blur', async()=>{
      const email = teacherEmailInput.value.trim();
      if(!email) return;
      const res = await fetch('/school-admin/teachers/<%= teacher._id %>/edit', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, checkField:'email' })
      });
      const data = await res.json();
      emailError.textContent = data.error || '';
    });

    // تحقق كلمة المرور
    teacherPasswordInput.addEventListener('blur', ()=>{
      const password = teacherPasswordInput.value.trim();
      if(password && !strongPasswordRegex.test(password)){
        passwordError.textContent="كلمة المرور يجب أن تحتوي على 8 أحرف على الأقل، حرف كبير، حرف صغير، رقم ورمز خاص";
      } else passwordError.textContent='';
    });

    // إرسال الفورم
    document.getElementById('editTeacherForm').addEventListener('submit', async e=>{
      e.preventDefault();
      nameError.textContent=''; emailError.textContent=''; passwordError.textContent='';

      const name = teacherNameInput.value.trim();
      const email = teacherEmailInput.value.trim();
      const password = teacherPasswordInput.value.trim();
      const phone = document.querySelector('input[name="phone"]').value;
      const classes = Array.from(classesSelect.selectedOptions).map(o=>o.value);
      const sections = Array.from(sectionsSelect.selectedOptions).map(o=>o.value);
      const subjects = Array.from(subjectsSelect.selectedOptions).map(o=>o.value);
      const status = statusSelect.value;

      let hasError=false;
      if(!name){ nameError.textContent="الاسم مطلوب"; hasError=true; }
      if(!email){ emailError.textContent="البريد الإلكتروني مطلوب"; hasError=true; }
      if(password && !strongPasswordRegex.test(password)){ passwordError.textContent="كلمة المرور يجب أن تحتوي على 8 أحرف على الأقل، حرف كبير، حرف صغير، رقم ورمز خاص"; hasError=true; }
      if(hasError) return;

      // تحقق البريد قبل الإرسال
      const emailCheckRes = await fetch('/school-admin/teachers/<%= teacher._id %>/edit',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, checkField:'email' })
      });
      const emailData = await emailCheckRes.json();
      if(emailData.error){ emailError.textContent=emailData.error; return; }

      const formData = {
        name,
        email,
        password: password || undefined,
        phone,
        classes: classes.length>0?classes:teacherClasses,
        sections: sections.length>0?sections:teacherSections,
        subjects: subjects.length>0?subjects:teacherSubjects,
        status
      };

      const res = await fetch('/school-admin/teachers/<%= teacher._id %>/edit',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(formData)
      });
      const data = await res.json();
      if(data.errors){
        if(data.errors.name) nameError.textContent=data.errors.name;
        if(data.errors.email) emailError.textContent=data.errors.email;
        if(data.errors.password) passwordError.textContent=data.errors.password;
        if(data.errors.general) alert(data.errors.general);
      } else if(data.success){
        alert(data.success);
        window.location.href="/school-admin/teachers";
      }
    });

    // تهيئة الصفحة
    initSelections();
  </script>

</body>
</html>
