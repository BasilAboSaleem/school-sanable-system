<!DOCTYPE html>
<html lang="ar">
<%- include('../../../partials/head.ejs') %>
<body class="rtl">
<div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">
  <%- include('../../../partials/header.ejs') %>
  <div id="dw-s1" class="bmd-layout-drawer bg-faded">
    <%- include('../../../partials/sidebar/index.ejs') %>
  </div>

  <main class="bmd-layout-content">
    <div class="container-fluid">

      <!-- Header -->
      <div class="row m-1 pb-4 mb-3">
        <div class="col-12 p-2">
          <div class="page-header breadcrumb-header d-flex justify-content-between align-items-center">
            <div>
              <h3 class="lite-text">تفاصيل الوارد</h3>
              <span class="lite-text text-gray">المورد: <%= income.supplierId ? income.supplierId.name : '—' %></span>
            </div>
            <div>
              <a href="/super-admin/incomes" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> رجوع
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- تفاصيل المبالغ -->
      <div class="row m-1 mb-3">
        <div class="col-md-4"><div class="alert alert-primary"><strong>المبلغ الكلي:</strong> <%= income.amount.toLocaleString() %> </div></div>
        <div class="col-md-4"><div class="alert alert-success"><strong>المبلغ الموزع:</strong> <%= distributedExpenses.reduce((sum,e)=>sum+e.amount,0).toLocaleString() %> </div></div>
        <div class="col-md-4"><div class="alert alert-info"><strong>المبلغ المتبقي:</strong> <%= (income.amount - distributedExpenses.reduce((sum,e)=>sum+e.amount,0)).toLocaleString() %> </div></div>
      </div>

      <!-- تفاصيل المورد -->
      <div class="row m-1 mb-3">
        <div class="col-12 p-2">
          <div class="card shade">
            <div class="card-header bg-secondary text-white"><i class="fas fa-info-circle"></i> تفاصيل المورد والوارد</div>
            <div class="card-body">
              <p><strong>اسم المورد:</strong> <%= income.supplierId?.name || '—' %></p>
              <p><strong>البريد الإلكتروني:</strong> <%= income.supplierId?.email || '—' %></p>
              <p><strong>الهاتف:</strong> <%= income.supplierId?.phone || '—' %></p>
              <p><strong>العنوان:</strong> <%= income.supplierId?.address || '—' %></p>
              <p><strong>الوصف الأصلي للوارد:</strong> <%= income.description || '—' %></p>
              <p><strong>تاريخ التسجيل:</strong> <%= income.createdAt.toLocaleDateString('ar-EG') %></p>
            </div>
          </div>
        </div>
      </div>

      <!-- توزيع الوارد -->
      <div class="row m-1 mb-3">
        <div class="col-12 p-2">
          <div class="card shade">
            <div class="card-header bg-primary text-white"><i class="fas fa-plus-circle"></i> توزيع الوارد على المدارس</div>
            <div class="card-body">

              <form id="distributeForm">

                <!-- خانة الوصف المخصص رجعت وأحسن من الأول -->
                <div class="form-group mb-4">
                  <label for="distributionDescription"><strong>الوصف الخاص بهذا التوزيع (اختياري)</strong></label>
                  <textarea 
                    id="distributionDescription"
                    name="distributionDescription" 
                    class="form-control" 
                    rows="3"
                    placeholder="مثال: توزيع دعم شهر يناير 2026 - مواد دراسية"></textarea>
                  <small class="text-muted">لو سبتها فاضية، هيتكتب وصف تلقائي</small>
                </div>

                <table class="table table-bordered table-hover text-center mb-4">
                  <thead class="thead-light">
                    <tr>
                      <th>#</th>
                      <th>المدرسة</th>
                      <th>المبلغ للتوزيع</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% schools.forEach((school, idx) => { %>
                      <tr>
                        <td><%= idx+1 %></td>
                        <td><%= school.name %></td>
                        <td>
                          <input type="number" 
                                 name="allocations[<%= idx %>][amount]" 
                                 min="0"
                                 class="form-control allocationInput" 
                                 placeholder="0">
                          <input type="hidden" name="allocations[<%= idx %>][schoolId]" value="<%= school._id %>">
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>

                <div class="alert alert-warning mb-3" id="allocationWarning" style="display:none;"></div>

                <button type="submit" class="btn btn-success btn-lg px-5">
                  <i class="fas fa-share-square"></i> توزيع المبلغ
                </button>

              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- التوزيعات السابقة - مع عرض الفئة والوصف بالعربي بشكل أجمل -->
      <div class="row m-1 mt-4">
        <div class="col-12 p-2">
          <div class="card shade">
            <div class="card-header bg-secondary text-white"><i class="fas fa-history"></i> التوزيعات السابقة</div>
            <div class="card-body p-0">
              <table class="table table-bordered table-hover text-center mb-0">
                <thead class="thead-dark">
                  <tr>
                    <th>#</th>
                    <th>المدرسة</th>
                    <th>المبلغ</th>
                    <th>الفئة</th>
                    <th>الوصف</th>
                    <th>التاريخ</th>
                  </tr>
                </thead>
                <tbody>
                  <% if(distributedExpenses.length === 0){ %>
                    <tr><td colspan="6" class="text-muted py-4">لا توجد توزيعات سابقة حتى الآن</td></tr>
                  <% } else { %>
                    <% distributedExpenses.forEach((exp, idx)=>{ %>
                      <tr>
                        <td><%= idx+1 %></td>
                        <td><strong><%= exp.schoolId?.name || '—' %></strong></td>
                        <td><strong><%= exp.amount.toLocaleString() %> </strong></td>
                        <td><%= exp.category || 'توزيع وارد' %></td>
                        <td><%= exp.description || 'توزيع تلقائي' %></td>
                        <td><%= exp.createdAt.toLocaleDateString('ar-EG') %></td>
                      </tr>
                    <% }) %>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<%- include('../../../partials/scripts.ejs') %>

<script>
  const maxAmount = <%= income.amount - distributedExpenses.reduce((sum,e)=>sum+e.amount,0) %>;
  const allocationInputs = document.querySelectorAll('.allocationInput');
  const warningBox = document.getElementById('allocationWarning');

  // تحذير فوري
  allocationInputs.forEach(input => {
    input.addEventListener('input', () => {
      let total = 0;
      allocationInputs.forEach(i => total += Number(i.value) || 0);
      if (total > maxAmount) {
        warningBox.style.display = 'block';
        warningBox.textContent = `تحذير: المجموع (${total.toLocaleString()}) أكبر من المتبقي (${maxAmount.toLocaleString()})`;
      } else {
        warningBox.style.display = 'none';
      }
    });
  });

  // التوزيع
  document.getElementById('distributeForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    let total = 0;
    const allocations = [];

    allocationInputs.forEach(input => {
      const amount = Number(input.value) || 0;
      if (amount <= 0) return;

      const tr = input.closest('tr');
      const hiddenInput = tr.querySelector('input[type="hidden"]');
      const schoolId = hiddenInput.value;

      total += amount;
      allocations.push({ amount, schoolId });
    });

    if (total > maxAmount) {
      alert(`المجموع (${total.toLocaleString()}) أكبر من المبلغ المتبقي`);
      return;
    }

    if (allocations.length === 0) {
      alert('يرجى إدخال مبلغ واحد على الأقل');
      return;
    }

    const distributionDescription = document.querySelector('[name="distributionDescription"]').value.trim();

    try {
      const res = await fetch(`/super-admin/incomes/<%= income._id %>/distribute`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          allocations, 
          distributionDescription: distributionDescription || null 
        })
      });

      const data = await res.json();

      if (data.errors) {
        alert(data.errors.general || 'حدث خطأ');
      } else {
        alert('تم توزيع المبلغ بنجاح بنجاح!');
        window.location.reload();
      }
    } catch (err) {
      console.error(err);
      alert('فشل الاتصال بالسيرفر');
    }
  });
</script>

</body>
</html>