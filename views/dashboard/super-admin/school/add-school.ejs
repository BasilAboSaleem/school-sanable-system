<!doctype html>
<html lang="ar">
<%- include('../../../partials/head.ejs') %>

<body class="rtl">

<div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">

  <%- include('../../../partials/header.ejs') %>

  <div id="dw-s1" class="bmd-layout-drawer bg-faded">
    <%- include('../../../partials/sidebar/index.ejs') %>
  </div>

  <main class="bmd-layout-content">
    <div class="container-fluid">

      <!-- Page Header -->
      <div class="row m-1 pb-3 mb-3">
        <div class="col-12 p-2">
          <div class="page-header breadcrumb-header d-flex justify-content-between align-items-center">
            <div>
              <h3 class="lite-text mb-1">
                <i class="fas fa-school"></i> إضافة مدرسة جديدة
              </h3>
              <span class="lite-text text-gray">
                إنشاء مدرسة جديدة مع حساب مدير المدرسة
              </span>
            </div>
            <div>
              <a href="/super-admin/schools" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> رجوع
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Card -->
      <div class="row m-1">
        <div class="col-12 p-2">
          <div class="card shade">

            <div class="card-header bg-primary text-white">
              <i class="fas fa-plus-circle"></i> بيانات المدرسة ومديرها
            </div>

            <div class="card-body">

              <form id="addSchoolForm" method="POST">

                <!-- ================= STEP 1 ================= -->
                <div id="step1">

                  <h5 class="mb-3 text-primary">
                    <i class="fas fa-building"></i> بيانات المدرسة
                  </h5>

                  <div class="row">
                    <div class="col-md-6 form-group">
                      <label>اسم المدرسة *</label>
                      <input type="text" id="nameInput" class="form-control" required>
                      <small class="text-danger" id="nameError"></small>
                    </div>

                    <div class="col-md-6 form-group">
                      <label>كود المدرسة *</label>
                      <input type="text" id="schoolCode" class="form-control" required>
                      <small class="text-danger" id="codeError"></small>
                    </div>

                    <div class="col-md-6 form-group">
                      <label>الهاتف</label>
                      <input type="text" name="phone" class="form-control">
                    </div>

                    <div class="col-md-6 form-group">
                      <label>البريد الإلكتروني</label>
                      <input type="email" name="email" class="form-control">
                    </div>

                    <div class="col-md-12 form-group">
                      <label>العنوان</label>
                      <input type="text" name="address" class="form-control">
                    </div>

                    <div class="col-md-4 form-group">
                      <label>حالة المدرسة</label>
                      <select name="status" class="form-control">
                        <option value="active">نشطة</option>
                        <option value="inactive">غير نشطة</option>
                      </select>
                    </div>
                  </div>

                  <button type="button" class="btn btn-primary mt-2" id="nextBtn">
                    التالي <i class="fas fa-arrow-left"></i>
                  </button>

                </div>

                <!-- ================= STEP 2 ================= -->
                <div id="step2" style="display:none;">

                  <h5 class="mb-3 text-success">
                    <i class="fas fa-user-shield"></i> بيانات مدير المدرسة
                  </h5>

                  <div class="row">
                    <div class="col-md-6 form-group">
                      <label>اسم المدير *</label>
                      <input type="text" id="adminNameInput" class="form-control" required>
                      <small class="text-danger" id="adminNameError"></small>
                    </div>

                    <div class="col-md-6 form-group">
                      <label>البريد الإلكتروني *</label>
                      <input type="email" id="adminEmail" class="form-control" required>
                      <small class="text-danger" id="emailError"></small>
                    </div>

                    <div class="col-md-6 form-group">
                      <label>كلمة المرور *</label>
                      <input type="password" id="adminPassword" class="form-control" required>
                      <small class="text-danger" id="passwordError"></small>
                      <small class="text-muted">
                        8 أحرف – حرف كبير – صغير – رقم – رمز
                      </small>
                    </div>
                  </div>

                  <hr>

                  <button type="button" class="btn btn-secondary" onclick="prevStep()">
                    <i class="fas fa-arrow-right"></i> السابق
                  </button>

                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> إضافة المدرسة
                  </button>

                </div>

              </form>

            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<%- include('../../../partials/scripts.ejs') %>

<script>
const nameInput = document.getElementById('nameInput');
const codeInput = document.getElementById('schoolCode');
const adminNameInput = document.getElementById('adminNameInput');
const emailInput = document.getElementById('adminEmail');
const passwordInput = document.getElementById('adminPassword');

const nameError = document.getElementById('nameError');
const codeError = document.getElementById('codeError');
const adminNameError = document.getElementById('adminNameError');
const emailError = document.getElementById('emailError');
const passwordError = document.getElementById('passwordError');

const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/;

// Step navigation
document.getElementById('nextBtn').addEventListener('click', async () => {
  nameError.textContent = '';
  codeError.textContent = '';

  if (!nameInput.value.trim()) {
    nameError.textContent = 'اسم المدرسة مطلوب';
    return;
  }

  const res = await fetch('/super-admin/schools/add', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ code: codeInput.value, checkField: 'code' })
  });
  const data = await res.json();
  if (data.error) {
    codeError.textContent = data.error;
    return;
  }

  step1.style.display = 'none';
  step2.style.display = 'block';
});

function prevStep() {
  step2.style.display = 'none';
  step1.style.display = 'block';
}

// Submit
document.getElementById('addSchoolForm').addEventListener('submit', async e => {
  e.preventDefault();

  adminNameError.textContent = '';
  emailError.textContent = '';
  passwordError.textContent = '';

  if (!adminNameInput.value.trim()) {
    adminNameError.textContent = 'اسم المدير مطلوب';
    return;
  }

  if (!strongPasswordRegex.test(passwordInput.value)) {
    passwordError.textContent = 'كلمة المرور غير قوية';
    return;
  }

  const payload = {
    name: nameInput.value,
    code: codeInput.value,
    address: document.querySelector('[name="address"]').value,
    phone: document.querySelector('[name="phone"]').value,
    email: document.querySelector('[name="email"]').value,
    status: document.querySelector('[name="status"]').value,
    adminName: adminNameInput.value,
    adminEmail: emailInput.value,
    adminPassword: passwordInput.value
  };

  const res = await fetch('/super-admin/schools/add', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  if (data.errors) {
    alert(data.errors.general || 'حدث خطأ');
  } else {
    alert('تم إضافة المدرسة بنجاح');
    window.location.href = '/super-admin/schools';
  }
});
</script>

</body>
</html>
