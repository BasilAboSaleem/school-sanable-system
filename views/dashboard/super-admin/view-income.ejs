<%- include('../../partials/head.ejs') %>
<body class="rtl">
<div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">
  <%- include('../../partials/header.ejs') %>
  <div id="dw-s1" class="bmd-layout-drawer bg-faded">
    <%- include('../../partials/sidebar/index.ejs') %>
  </div>
  <main class="bmd-layout-content">
    <div class="container-fluid">
      <h3>بيانات الوارد: <%= income.amount %> من المورد <%= income.supplierId.name %></h3>

      <h5>توزيع الوارد على المدارس</h5>
      <form id="distributeForm">
        <% schools.forEach(school => { %>
          <div class="form-group">
            <label><%= school.name %></label>
            <input type="number" name="allocations[<%= school._id %>]" value="0" class="form-control">
          </div>
        <% }) %>
        <button type="submit" class="btn btn-success">توزيع الوارد</button>
      </form>

      <h5>الواردات الموزعة</h5>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>المدرسة</th>
            <th>المبلغ</th>
            <th>الوصف</th>
          </tr>
        </thead>
        <tbody>
          <% distributedExpenses.forEach(exp => { %>
            <tr>
              <td><%= exp.schoolId.name %></td>
              <td><%= exp.amount %></td>
              <td><%= exp.description %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </main>
</div>

<%- include('../../partials/scripts.ejs') %>

<script>
document.getElementById('distributeForm').addEventListener('submit', async e => {
  e.preventDefault();
  const formData = [];
  for (let input of e.target.querySelectorAll('input[name^="allocations"]')) {
    formData.push({ schoolId: input.name.match(/\[(.*)\]/)[1], amount: Number(input.value) });
  }
  const res = await fetch('/super-admin/incomes/<%= income._id %>/distribute', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ allocations: formData })
  });
  const data = await res.json();
  if(data.success) window.location.reload();
  if(data.errors) alert(data.errors.general);
});
</script>
</body>
