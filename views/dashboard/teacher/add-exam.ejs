<%- include('../../partials/head.ejs') %>
<body class="rtl">
<div class="bmd-layout-container bmd-drawer-f-l avam-container animated bmd-drawer-in">
  <%- include('../../partials/header.ejs') %>
  <div id="dw-s1" class="bmd-layout-drawer bg-faded">
    <%- include('../../partials/sidebar/index.ejs') %>
  </div>

<main class="bmd-layout-content">
  <div class="container-fluid mt-3">
    <input type="hidden" name="_csrf" id="csrfToken" value="<%= csrfToken %>">
    <h3>إضافة اختبار جديد</h3>

    <div class="row mb-3">
      <!-- الصف الأول: الفصل، الشعبة، المادة، نوع الاختبار -->
      <div class="col-md-3">
        <label>الفصل</label>
        <select id="classSelect" class="form-control">
          <option value="">-- اختر الفصل --</option>
          <% classes.forEach(c => { %>
            <option value="<%= c._id %>"><%= c.name %></option>
          <% }) %>
        </select>
      </div>

      <div class="col-md-3">
        <label>الشعبة</label>
        <select id="sectionSelect" class="form-control" disabled>
          <option value="">-- اختر الشعبة --</option>
        </select>
      </div>

      <div class="col-md-3">
        <label>المادة</label>
        <select id="subjectSelect" class="form-control">
          <option value="">-- اختر المادة --</option>
          <% subjects.forEach(s => { %>
            <option value="<%= s._id %>"><%= s.name %></option>
          <% }) %>
        </select>
      </div>

      <div class="col-md-3">
        <label>نوع الاختبار</label>
        <select id="examTypeSelect" name="type" class="form-control" required>
          <option value="">-- اختر نوع الاختبار --</option>
          <option value="monthly">شهري</option>
          <option value="midterm">نصفي</option>
          <option value="final">نهائي</option>
          <option value="quiz">كويز</option>
        </select>
      </div>
    </div>

    <div class="row mb-3">
      <!-- الصف الثاني: الدرجة القصوى، تاريخ الاختبار -->
      <div class="col-md-3">
        <label>الدرجة القصوى</label>
        <input type="number" id="maxScore" class="form-control" placeholder="مثال: 100" min="1">
      </div>

      <div class="col-md-3">
        <label>تاريخ الاختبار</label>
        <input type="date" id="examDate" class="form-control">
      </div>

      <div class="col-md-6">
        <label>رابط الملف (اختياري)</label>
        <input type="text" id="fileUrl" class="form-control" placeholder="رابط PDF / DOCX">
      </div>
    </div>

    <div class="row">
      <!-- زر الإضافة -->
      <div class="col-md-12 text-right">
        <button id="addExamBtn" class="btn btn-primary">إضافة الاختبار</button>
      </div>
    </div>

  </div>
</main>

</div>

<%- include('../../partials/scripts.ejs') %>

<script>
const classSelect = document.getElementById('classSelect');
const sectionSelect = document.getElementById('sectionSelect');
const subjectSelect = document.getElementById('subjectSelect');
const examTypeSelect = document.getElementById('examTypeSelect');
const maxScoreInput = document.getElementById('maxScore');

const examDate = document.getElementById('examDate');
const fileUrl = document.getElementById('fileUrl');
const addExamBtn = document.getElementById('addExamBtn');
const csrfToken = document.getElementById('csrfToken').value;

// جلب الشعب عند اختيار الفصل
classSelect.addEventListener('change', async () => {
  sectionSelect.innerHTML = '<option value="">-- اختر الشعبة --</option>';
  if (!classSelect.value) return sectionSelect.disabled = true;

  const res = await fetch(`/teacher/classes/${classSelect.value}/sections`);
  const sections = await res.json();

  sections.forEach(s => {
    sectionSelect.innerHTML += `<option value="${s._id}">${s.name}</option>`;
  });

  sectionSelect.disabled = false;
});

// إضافة الاختبار
addExamBtn.addEventListener('click', async () => {
  const examType = examTypeSelect.value;
  const maxScore = maxScoreInput.value;

  if (!classSelect.value || !sectionSelect.value || !subjectSelect.value || !examDate.value || !examType || !maxScore) {
    return alert("جميع الحقول مطلوبة");
  }

  const res = await fetch('/teacher/exams/add', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json', 
      'CSRF-Token': csrfToken 
    },
    body: JSON.stringify({
      type: examType,
      maxScore: Number(maxScore),
      classId: classSelect.value,
      sectionId: sectionSelect.value,
      subjectId: subjectSelect.value,
      examDate: examDate.value,
      fileUrl: fileUrl.value
    })
  });

  const data = await res.json();

  if (data.error) return alert(data.error);
  alert(data.success);

  // إعادة ضبط الفورم
  classSelect.value = '';
  sectionSelect.innerHTML = '<option value="">-- اختر الشعبة --</option>';
  sectionSelect.disabled = true;
  subjectSelect.value = '';
  examTypeSelect.value = '';
  maxScoreInput.value = '';
  examDate.value = '';
  fileUrl.value = '';
});
</script>


</body>
</html>
